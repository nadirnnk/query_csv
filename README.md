# AI CSV Analyst (query_csv)

A small prototype that lets a user upload a CSV, ask natural-language questions about it, and receives back Python (pandas/matplotlib) code and results generated by an LLM.


## Features

- Upload CSV files (FastAPI endpoint)
- Ask natural-language questions about the uploaded CSV
- LLM generates Python code (pandas/matplotlib) to answer the question
- Execute generated code against the DataFrame and return numeric results and optional plot images
- Session/chat history (in-memory) so the LLM has conversation context

## Repo layout (important files)

- `app.py` — Streamlit frontend (demo + manual testing UI)
- `main.py` — FastAPI application bootstrap
- `route.py` — API router with `/upload` and `/chat` endpoints
- `data.py` — CSV save/get helpers and in-memory cache
- `calls.py` — LLM integration, session store and code generation glue
- `utils/sand.py` — Executes generated Python code in a restricted globals/locals
- `models/schemas.py` — Pydantic request/response schemas
- `storage/uploads/` — uploaded CSVs (UUID.csv)

## Quick design contract (2–3 bullets)

- Input: CSV file and a natural-language query + user_id
- Output: Generated python code, numeric result (or error), and optional plot image (base64)
- Success criteria: Backend returns a numeric `result` and optionally `image` and `generated_code`

## Quickstart (development) — Windows PowerShell

1. Create and activate a virtual environment or conda environment. Example using pip/venv:

```powershell
python -m venv .venv
.\.venv\Scripts\Activate.ps1
pip install --upgrade pip
```

Or using conda (you used `test` earlier):

```powershell
conda create -n test python=3.11 -y
conda activate test
```

2. Install dependencies (create a `requirements.txt` if you prefer). Minimal packages required:

```powershell
pip install fastapi uvicorn[standard] streamlit pandas python-multipart pydantic python-dotenv requests pillow pytest
```

3. Set environment variables (required):

```powershell
$env:OPENAI_API_KEY = 'sk-...'
```

4. Run the backend API (FastAPI):

```powershell
uvicorn main:app --reload --host 127.0.0.1 --port 8000
```

5. Run the Streamlit frontend in a second terminal:

```powershell
streamlit run app.py
```

6. Open the Streamlit UI in your browser (usually http://localhost:8501) to upload a CSV and ask queries.

## API Endpoints

- POST `/upload` — multipart file upload (returns `file_id`)
- POST `/chat` — body: `{ user_id, file_id, query }` — returns generated code, result, image, error, and user_id
- GET `/chat/history/{user_id}` — returns in-memory chat history for that `user_id`

